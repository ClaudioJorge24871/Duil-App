@model Duil_App.Models.Encomendas

@using Duil_App.Models

@{
    ViewData["Title"] = "Nova Encomenda";
    var clienteId = ViewBag.ClienteId as string;
    ViewData["Estado"] = new SelectList(Enum.GetValues(typeof(Estados)));
}

@if (!User.IsInRole("Cliente"))
{
    <div>
        <a asp-action="Index"><i class="bi bi-arrow-left fs-3 ms-3" style="color:#6B97AC"></i></a>
    </div>
}

<div class="d-flex justify-content-center mt-5 min-vh-100">
    <div class="container mt-5" style="width:80%">
        <h3 class="mb-2 grey-text">Nova encomenda</h3>
        <hr />

        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Top fields: Ordem de Encomenda e Data -->
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <input asp-for="IdLadoCliente" class="form-control form-control-lg" placeholder="Ordem de Encomenda" />
                    <span asp-validation-for="IdLadoCliente" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <input asp-for="Data" type="date" class="form-control form-control-lg" value="@DateTime.Today:yyyy-MM-dd" />
                    <span asp-validation-for="Data" class="text-danger"></span>
                </div>
            </div>

            <!-- Middle fields: Cliente e Transportadora -->
            <div class="row mb-4">
                <div class="col-md-6">
                    @if (User.IsInRole("Cliente"))
                    {
                        <input type="hidden" asp-for="ClienteId" value="@clienteId" id="ClienteId" />
                        <p class="lead">Cliente autenticado: @ViewBag.ClienteNome</p>
                    }
                    else
                    {
                        <input type="hidden" asp-for="ClienteId" id="ClienteId" />
                        <input type="text" id="cliente-nome" class="form-control" placeholder="Nome do cliente" autocomplete="off" />
                        <span asp-validation-for="ClienteId" class="text-danger"></span>
                    }
                </div>
                <div class="col-md-6">
                    <input asp-for="Transportadora" class="form-control" placeholder="Transportadora" />
                    <span asp-validation-for="Transportadora" class="text-danger"></span>
                </div>
            </div>

            <!-- Peças Section -->
            <div id="pecasSection">
                <div id="sem-cliente" class="text-center mt-5">
                    <h2 class="text-muted">Por favor, adicione um cliente para ver as peças</h2>
                </div>
                <div id="pecasCards" class="row g-3"></div>
                <div class="mt-3">
                    <button type="button" id="addPecaBtn" class="btn btn-secondary" disabled>Adicionar Peça</button>
                </div>
            </div>

            <!-- Estado as Select from Enum -->
            <div class="form-group mt-4">
                <label asp-for="Estado" class="form-label">Estado</label>
                <select asp-for="Estado" asp-items="ViewBag.Estado" class="form-control">
                    <option value="">-- Selecione Estado --</option>
                </select>
                <span asp-validation-for="Estado" class="text-danger"></span>
            </div>

            <!-- Totais -->
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <input type="text" id="QuantidadeTotal_Visivel" class="form-control" placeholder="Quantidade Total" readonly />
                    <input type="hidden" asp-for="QuantidadeTotal" />
                </div>
                <div class="col-md-6 mb-3">
                    <input type="text" id="TotalPrecoUnit_Visivel" class="form-control" placeholder="Preço Total (€)" readonly />
                    <input type="hidden" asp-for="TotalPrecoUnit" />
                </div>
            </div>

            <div class="form-group mb-3">
                <input type="submit" value="Criar" class="btn btn-custom mt-3" />
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

    <script>
        $(function () {
            let pecasData = {};
            let loaded = false;

            function toggleSection() {
                const cId = $('#ClienteId').val();
                if (cId) {
                    $('#sem-cliente').hide();
                    $('#addPecaBtn').prop('disabled', false);
                    if (!loaded) loadPecas(cId);
                } else {
                    $('#sem-cliente').show();
                    $('#pecasCards').empty();
                    $('#addPecaBtn').prop('disabled', true);
                }
            }

            function loadPecas(clienteId) {
                $.getJSON(`/Encomendas/GetPecasPorCliente?clienteId=${clienteId}`, function (data) {
                    console.log(data);
                    pecasData = {};
                    data.forEach(p => pecasData[p.id] = p);
                    renderAllCards();
                    loaded = true;
                });
            }

            function renderAllCards() {
                $('#pecasCards').empty();
                Object.keys(pecasData).forEach(id => {
                    $('#pecasCards').append(createCard(id));
                });
                updateTotals();
            }

            function updateTotals() {
                let totalQty = 0, totalPrice = 0;
                $('#pecasCards .card-body').each(function () {
                    const id = $(this).data('id');
                    const qty = parseInt($(this).find('.peca-qty').val()) || 0;
                    if (id && pecasData[id]) {
                        totalQty += qty;
                        totalPrice += parseFloat(pecasData[id].preco) * qty;
                    }
                });
                $('#QuantidadeTotal_Visivel').val(totalQty);
                $('#TotalPrecoUnit_Visivel').val(totalPrice.toFixed(2).replace(',', ',').replace('.', ','));
                $('input[name="QuantidadeTotal"]').val(totalQty);
                $('input[name="TotalPrecoUnit"]').val(totalPrice.toFixed(2));
            }

            function createCard(id) {
                const p = pecasData[id];
                const displayPrice = parseFloat(p.preco).toFixed(2).replace('.', ',');
                return `
                        <div class="col-md-4">
                          <div class="card shadow-sm">
                            <img src="${p.imagem}"
                                class="card-img-top img-fluid"
                                alt="${p.nome}"
                                style="max-width:100%; max-height:100px; object-fit:contain;" />
                            <div class="card-body" data-id="${id}">
                              <h5 class="card-title">${p.nome}</h5>
                              <p class="card-text">Preço unitário: ${displayPrice} €</p>
                              <div class="input-group mb-2">
                                <input type="number" class="form-control peca-qty" value="1" min="1">
                                <button class="btn btn-danger remove-card">Remover</button>
                              </div>
                            </div>
                          </div>
                        </div>`;
            }

            $('#addPecaBtn').click(function () {
                const ids = Object.keys(pecasData).filter(id => !$('#pecasCards .card-body').filter(`*[data-id='${id}']`).length);
                if (!ids.length) return;
                const id = ids[0];
                $('#pecasCards').append(createCard(id));
                updateTotals();
            });

            $(document).on('click', '.remove-card', function () {
                $(this).closest('.col-md-4').remove();
                updateTotals();
            });

            $(document).on('input change', '.peca-qty', updateTotals);

            $('#cliente-nome').autocomplete({
                source: '/Clientes/Search', minLength: 1,
                select: (e, ui) => {
                    $('#cliente-nome').val(ui.item.label);
                    $('#ClienteId').val(ui.item.value);
                    toggleSection();
                    return false;
                }
            });

            $('#cliente-nome').on('input', function () { $('#ClienteId').val(''); toggleSection(); });
            toggleSection();
        });
    </script>
}
